import pytest
from vulnerability_scanner import VulnerabilityScanner


def test_known_vulnerability_detection():
    scanner = VulnerabilityScanner()
    result = scanner.scan('http://testserver/vuln-page')
    assert 'CVE-2021-41773' in result['vulnerabilities']


def test_invalid_target_handling():
    scanner = VulnerabilityScanner()
    with pytest.raises(ValueError):
        scanner.scan('invalid_url')


def test_empty_service_detection(monkeypatch):
    def mock_detect(*args, **kwargs):
        return []
    
    scanner = VulnerabilityScanner()
    monkeypatch.setattr(scanner, 'detect_services', mock_detect)
    
    result = scanner.scan('http://empty-server')
    assert 'service_detection_failed' in result['warnings']


def test_mocked_service_detection():
    scanner = VulnerabilityScanner()
    result = scanner.scan('http://mock-server')
    assert 'mock_service' in result['detected_services']